generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")  // Used for migrations, bypasses connection pooler
}

// ============================================================================
// AUTHENTICATION & USERS
// ============================================================================

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id               String       @id @default(uuid())
  email            String       @unique
  name             String?
  image            String?
  emailVerified    DateTime?    // Required by NextAuth Prisma Adapter
  role             UserRole     @default(Editor)
  phone            String?
  address          String?
  defaultBakeryId  String?      // User's preferred/default bakery
  defaultBakery    Bakery?      @relation("DefaultBakery", fields: [defaultBakeryId], references: [id])
  bakeries         UserBakery[] // Bakeries this user can access
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  accounts         Account[]
  sessions         Session[]
}

// Junction table for User <-> Bakery (many-to-many)
model UserBakery {
  id        String   @id @default(uuid())
  userId    String
  bakeryId  String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bakery    Bakery   @relation(fields: [bakeryId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, bakeryId])
  @@index([userId])
  @@index([bakeryId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  Editor
  Manager
}

// ============================================================================
// BAKERY (Multi-location support)
// ============================================================================

model Bakery {
  id                   String          @id @default(uuid())
  name                 String
  location             String?         // e.g., "Conakry - Centre", "Conakry - Kaloum"
  openingDate          DateTime?
  initialCapital       Float           @default(0)
  initialCashBalance   Float           @default(0)
  initialOrangeBalance Float           @default(0)
  initialCardBalance   Float           @default(0)
  contactPhone         String?
  contactEmail         String?
  managerName          String?
  currency             String          @default("GNF")
  trackingStartDate    DateTime?
  stockDeductionMode   String          @default("immediate") // "immediate" | "deferred"
  isActive             Boolean         @default(true)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  // Relations
  users                UserBakery[]
  defaultForUsers      User[]          @relation("DefaultBakery")
  inventoryItems       InventoryItem[]
  stockMovements       StockMovement[]
  productionLogs       ProductionLog[]
  sales                Sale[]
  expenses             Expense[]
  cashDeposits         CashDeposit[]
  dailySummaries       DailySummary[]

  @@index([isActive])
}

// ============================================================================
// INVENTORY MANAGEMENT
// ============================================================================

model InventoryItem {
  id             String          @id @default(uuid())
  bakeryId       String
  bakery         Bakery          @relation(fields: [bakeryId], references: [id])
  name           String
  nameFr         String?
  category       String
  unit           String
  currentStock   Float           @default(0)
  minStock       Float           @default(0)
  reorderPoint   Float           @default(0)
  unitCostGNF    Float           @default(0)
  supplierId     String?
  supplier       Supplier?       @relation(fields: [supplierId], references: [id])
  expiryDays     Int?
  isActive       Boolean         @default(true)
  stockMovements StockMovement[]
  expenseItems   ExpenseItem[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([bakeryId])
  @@index([category])
  @@index([supplierId])
  @@index([isActive])
}

model StockMovement {
  id              String         @id @default(uuid())
  bakeryId        String
  bakery          Bakery         @relation(fields: [bakeryId], references: [id])
  itemId          String
  item            InventoryItem  @relation(fields: [itemId], references: [id])
  type            MovementType
  quantity        Float
  unitCost        Float?
  reason          String?
  productionLogId String?
  productionLog   ProductionLog? @relation(fields: [productionLogId], references: [id])
  expenseId       String?
  expense         Expense?       @relation(fields: [expenseId], references: [id])
  createdBy       String
  createdByName   String?
  createdAt       DateTime       @default(now())

  @@index([bakeryId])
  @@index([itemId])
  @@index([type])
  @@index([createdAt])
}

enum MovementType {
  Purchase
  Usage
  Waste
  Adjustment
}

// ============================================================================
// PRODUCTION TRACKING
// ============================================================================

model ProductionLog {
  id                  String            @id @default(uuid())
  bakeryId            String
  bakery              Bakery            @relation(fields: [bakeryId], references: [id])
  date                DateTime
  productName         String
  productNameFr       String?
  quantity            Int
  ingredients         Json              // Basic recipe ingredients list
  ingredientDetails   Json?             // Detailed breakdown: [{itemId, itemName, plannedQty, actualQty, unit}]
  estimatedCostGNF    Float?            // Calculated cost from ingredients
  preparationStatus   ProductionStatus  @default(Planning)
  notes               String?
  status              SubmissionStatus  @default(Pending)
  stockDeducted       Boolean           @default(false)   // Whether stock has been deducted
  stockDeductedAt     DateTime?                           // When stock was deducted
  createdBy           String
  createdByName       String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  stockMovements      StockMovement[]

  @@index([bakeryId])
  @@index([date])
  @@index([status])
  @@index([preparationStatus])
}

enum ProductionStatus {
  Planning    // Production is being planned
  Ready       // All ingredients available, ready to start
  InProgress  // Production is underway
  Complete    // Production finished
}

// ============================================================================
// SALES TRACKING
// ============================================================================

model Sale {
  id                 String           @id @default(uuid())
  bakeryId           String
  bakery             Bakery           @relation(fields: [bakeryId], references: [id])
  date               DateTime
  totalGNF           Float
  totalEUR           Float            @default(0)
  cashGNF            Float            @default(0)
  orangeMoneyGNF     Float            @default(0)
  cardGNF            Float            @default(0)
  itemsCount         Int?
  customersCount     Int?
  receiptUrl         String?
  openingTime        String?
  closingTime        String?
  comments           String?
  status             SubmissionStatus @default(Pending)
  submittedBy        String?
  submittedByName    String?
  approvedBy         String?
  approvedByName     String?
  approvedAt         DateTime?
  lastModifiedBy     String?
  lastModifiedByName String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  cashDeposit        CashDeposit?

  @@unique([bakeryId, date]) // One sale per bakery per day
  @@index([bakeryId])
  @@index([date])
  @@index([status])
}

enum SubmissionStatus {
  Pending
  Approved
  Rejected
}

// ============================================================================
// EXPENSE MANAGEMENT
// ============================================================================

model Expense {
  id                  String           @id @default(uuid())
  bakeryId            String
  bakery              Bakery           @relation(fields: [bakeryId], references: [id])
  date                DateTime
  categoryId          String?
  category            Category?        @relation(fields: [categoryId], references: [id])
  categoryName        String
  amountGNF           Float
  amountEUR           Float            @default(0)
  paymentMethod       PaymentMethod
  description         String?
  receiptUrl          String?
  comments            String?
  transactionRef      String?
  status              SubmissionStatus @default(Pending)
  submittedBy         String?
  submittedByName     String?
  approvedBy          String?
  approvedByName      String?
  approvedAt          DateTime?
  lastModifiedBy      String?
  lastModifiedByName  String?
  lastModifiedAt      DateTime?
  supplierId          String?
  supplier            Supplier?        @relation(fields: [supplierId], references: [id])
  isInventoryPurchase Boolean          @default(false)
  stockMovements      StockMovement[]
  expenseItems        ExpenseItem[]
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  @@index([bakeryId])
  @@index([date])
  @@index([status])
  @@index([categoryId])
  @@index([supplierId])
}

// Junction table for Expense <-> InventoryItem (many-to-many for inventory purchases)
model ExpenseItem {
  id              String        @id @default(uuid())
  expenseId       String
  expense         Expense       @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  quantity        Float
  unitCostGNF     Float

  @@index([expenseId])
  @@index([inventoryItemId])
}

enum PaymentMethod {
  Cash
  OrangeMoney
  Card
}

// ============================================================================
// CATEGORIES & SUPPLIERS (Shared across bakeries)
// ============================================================================

model Category {
  id             String             @id @default(uuid())
  name           String             @unique
  nameFr         String?
  color          String?
  expenseGroupId String?
  expenseGroup   ExpenseGroup?      @relation(fields: [expenseGroupId], references: [id])
  suppliers      CategorySupplier[]
  expenses       Expense[]
  isActive       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
}

model ExpenseGroup {
  id         String     @id @default(uuid())
  key        String     @unique
  label      String
  labelFr    String?
  icon       String
  color      String
  sortOrder  Int        @default(0)
  isActive   Boolean    @default(true)
  categories Category[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model Supplier {
  id             String             @id @default(uuid())
  name           String             @unique
  phone          String?
  email          String?
  address        String?
  paymentTerms   String?
  isActive       Boolean            @default(true)
  expenses       Expense[]
  categories     CategorySupplier[]
  inventoryItems InventoryItem[]
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
}

model CategorySupplier {
  id         String   @id @default(uuid())
  categoryId String
  supplierId String
  category   Category @relation(fields: [categoryId], references: [id])
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  @@unique([categoryId, supplierId])
}

// ============================================================================
// CASH DEPOSITS
// ============================================================================

model CashDeposit {
  id              String            @id @default(uuid())
  bakeryId        String
  bakery          Bakery            @relation(fields: [bakeryId], references: [id])
  date            DateTime
  amount          Float
  status          CashDepositStatus @default(Pending)
  bankRef         String?
  receiptUrl      String?
  comments        String?
  depositedBy     String?
  depositedByName String?
  depositedAt     DateTime?
  saleId          String?           @unique
  sale            Sale?             @relation(fields: [saleId], references: [id])
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([bakeryId])
  @@index([date])
  @@index([status])
}

enum CashDepositStatus {
  Pending
  Deposited
}

// ============================================================================
// DAILY SUMMARY (Per Bakery)
// ============================================================================

model DailySummary {
  id                      String   @id @default(uuid())
  bakeryId                String
  bakery                  Bakery   @relation(fields: [bakeryId], references: [id])
  date                    DateTime
  dailyCashSales          Float    @default(0)
  dailyOrangeSales        Float    @default(0)
  dailyCardSales          Float    @default(0)
  dailyCashExpenses       Float    @default(0)
  dailyOrangeExpenses     Float    @default(0)
  dailyCardExpenses       Float    @default(0)
  cumulativeCashBalance   Float    @default(0)
  cumulativeOrangeBalance Float    @default(0)
  cumulativeCardBalance   Float    @default(0)
  lowStockItemsCount      Int      @default(0)
  criticalStockItemsCount Int      @default(0)
  totalInventoryValueGNF  Float    @default(0)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@unique([bakeryId, date]) // One summary per bakery per day
  @@index([bakeryId])
  @@index([date])
}
