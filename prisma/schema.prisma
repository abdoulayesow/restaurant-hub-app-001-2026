generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                     String                  @id @default(uuid())
  email                  String                  @unique
  name                   String?
  image                  String?
  role                   UserRole                @default(Editor)
  phone                  String?
  address                String?
  defaultRestaurantId    String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  emailVerified          DateTime?
  accounts               Account[]
  notificationPreference NotificationPreference?
  sessions               Session[]
  defaultRestaurant      Restaurant?             @relation("DefaultRestaurant", fields: [defaultRestaurantId], references: [id])
  restaurants            UserRestaurant[]
}

model UserRestaurant {
  id           String     @id @default(uuid())
  userId       String
  restaurantId String
  createdAt    DateTime   @default(now())
  role         UserRole   @default(RestaurantManager)
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, restaurantId])
  @@index([userId])
  @@index([restaurantId])
  @@index([role])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Restaurant {
  id                   String                @id @default(uuid())
  name                 String
  location             String?
  openingDate          DateTime?
  initialCapital       Float                 @default(0)
  initialCashBalance   Float                 @default(0)
  initialOrangeBalance Float                 @default(0)
  initialCardBalance   Float                 @default(0)
  contactPhone         String?
  contactEmail         String?
  managerName          String?
  currency             String                @default("GNF")
  trackingStartDate    DateTime?
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  stockDeductionMode   String                @default("immediate")
  restaurantType       RestaurantType        @default(Bakery)
  inventoryEnabled     Boolean               @default(true)
  productionEnabled    Boolean               @default(true)
  bankTransactions     BankTransaction[]
  customers            Customer[]
  dailySummaries       DailySummary[]
  debts                Debt[]
  debtPayments         DebtPayment[]
  expenses             Expense[]
  inventoryItems       InventoryItem[]
  transfersOut         InventoryTransfer[]   @relation("TransfersOut")
  transfersIn          InventoryTransfer[]   @relation("TransfersIn")
  notificationLogs     NotificationLog[]
  paymentMethods       PaymentMethod[]
  products             Product[]
  productionLogs       ProductionLog[]
  sales                Sale[]
  stockMovements       StockMovement[]
  stockReconciliations StockReconciliation[]
  defaultForUsers      User[]                @relation("DefaultRestaurant")
  users                UserRestaurant[]

  @@index([isActive])
  @@index([restaurantType])
}

model InventoryItem {
  id                  String               @id @default(uuid())
  restaurantId        String
  name                String
  nameFr              String?
  category            String
  unit                String
  currentStock        Float                @default(0)
  minStock            Float                @default(0)
  reorderPoint        Float                @default(0)
  unitCostGNF         Float                @default(0)
  supplierId          String?
  expiryDays          Int?
  isActive            Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  expenseItems        ExpenseItem[]
  restaurant          Restaurant           @relation(fields: [restaurantId], references: [id])
  supplier            Supplier?            @relation(fields: [supplierId], references: [id])
  transfersFrom       InventoryTransfer[]  @relation("TransfersFrom")
  transfersTo         InventoryTransfer[]  @relation("TransfersTo")
  reconciliationItems ReconciliationItem[]
  stockMovements      StockMovement[]

  @@index([restaurantId])
  @@index([category])
  @@index([supplierId])
  @@index([isActive])
  @@index([restaurantId, isActive, category])
}

model StockMovement {
  id              String         @id @default(uuid())
  restaurantId    String
  itemId          String
  type            MovementType
  quantity        Float
  unitCost        Float?
  reason          String?
  productionLogId String?
  expenseId       String?
  createdBy       String
  createdByName   String?
  createdAt       DateTime       @default(now())
  expense         Expense?       @relation(fields: [expenseId], references: [id])
  item            InventoryItem  @relation(fields: [itemId], references: [id])
  productionLog   ProductionLog? @relation(fields: [productionLogId], references: [id])
  restaurant      Restaurant     @relation(fields: [restaurantId], references: [id])

  @@index([restaurantId])
  @@index([itemId])
  @@index([type])
  @@index([createdAt])
  @@index([itemId, createdAt])
  @@index([restaurantId, type, createdAt])
}

model InventoryTransfer {
  id                 String         @id @default(uuid())
  sourceRestaurantId String
  targetRestaurantId String
  sourceItemId       String
  targetItemId       String?
  quantity           Float
  reason             String?
  createdBy          String
  createdByName      String?
  createdAt          DateTime       @default(now())
  sourceItem         InventoryItem  @relation("TransfersFrom", fields: [sourceItemId], references: [id])
  sourceRestaurant   Restaurant     @relation("TransfersOut", fields: [sourceRestaurantId], references: [id])
  targetItem         InventoryItem? @relation("TransfersTo", fields: [targetItemId], references: [id])
  targetRestaurant   Restaurant     @relation("TransfersIn", fields: [targetRestaurantId], references: [id])

  @@index([sourceRestaurantId])
  @@index([targetRestaurantId])
  @@index([sourceItemId])
  @@index([createdAt])
}

model StockReconciliation {
  id              String               @id @default(uuid())
  restaurantId    String
  date            DateTime             @default(now())
  status          SubmissionStatus     @default(Pending)
  submittedBy     String
  submittedByName String?
  approvedBy      String?
  approvedByName  String?
  approvedAt      DateTime?
  notes           String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  items           ReconciliationItem[]
  restaurant      Restaurant           @relation(fields: [restaurantId], references: [id])

  @@index([restaurantId])
  @@index([status])
}

model ReconciliationItem {
  id                String              @id @default(uuid())
  reconciliationId  String
  inventoryItemId   String
  systemStock       Float
  physicalCount     Float
  variance          Float
  adjustmentApplied Boolean             @default(false)
  inventoryItem     InventoryItem       @relation(fields: [inventoryItemId], references: [id])
  reconciliation    StockReconciliation @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)

  @@index([reconciliationId])
  @@index([inventoryItemId])
}

model ProductionLog {
  id                String           @id @default(uuid())
  restaurantId      String
  date              DateTime
  productName       String
  productNameFr     String?
  quantity          Int
  ingredients       Json
  notes             String?
  status            SubmissionStatus @default(Pending)
  createdBy         String
  createdByName     String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  estimatedCostGNF  Float?
  ingredientDetails Json?
  preparationStatus ProductionStatus @default(Planning)
  stockDeducted     Boolean          @default(false)
  stockDeductedAt   DateTime?
  productionType    ProductCategory?
  productionItems   ProductionItem[]
  restaurant        Restaurant       @relation(fields: [restaurantId], references: [id])
  stockMovements    StockMovement[]

  @@index([restaurantId])
  @@index([date])
  @@index([status])
  @@index([preparationStatus])
  @@index([productionType])
  @@index([restaurantId, status, date])
}

model Product {
  id              String           @id @default(uuid())
  restaurantId    String
  name            String
  nameFr          String?
  category        ProductCategory
  unit            String           @default("piece")
  standardRecipe  Json?
  isActive        Boolean          @default(true)
  sortOrder       Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  priceGNF        Float?
  restaurant      Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  productionItems ProductionItem[]
  saleItems       SaleItem[]

  @@index([restaurantId])
  @@index([category])
  @@index([isActive])
  @@index([restaurantId, category, isActive])
}

model ProductionItem {
  id              String        @id @default(uuid())
  productionLogId String
  productId       String
  quantity        Int
  product         Product       @relation(fields: [productId], references: [id])
  productionLog   ProductionLog @relation(fields: [productionLogId], references: [id], onDelete: Cascade)

  @@index([productionLogId])
  @@index([productId])
}

model Sale {
  id                 String            @id @default(uuid())
  restaurantId       String
  date               DateTime
  totalGNF           Float
  totalEUR           Float             @default(0)
  cashGNF            Float             @default(0)
  orangeMoneyGNF     Float             @default(0)
  cardGNF            Float             @default(0)
  itemsCount         Int?
  customersCount     Int?
  receiptUrl         String?
  openingTime        String?
  closingTime        String?
  comments           String?
  status             SubmissionStatus  @default(Pending)
  submittedBy        String?
  submittedByName    String?
  approvedBy         String?
  approvedByName     String?
  approvedAt         DateTime?
  lastModifiedBy     String?
  lastModifiedByName String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  bankTransactions   BankTransaction[] @relation("BankTransactionSale")
  debts              Debt[]
  restaurant         Restaurant        @relation(fields: [restaurantId], references: [id])
  saleItems          SaleItem[]

  @@unique([restaurantId, date])
  @@index([restaurantId])
  @@index([date])
  @@index([status])
  @@index([restaurantId, status, date])
}

model SaleItem {
  id            String   @id @default(uuid())
  saleId        String
  productId     String?
  productName   String?
  productNameFr String?
  quantity      Int
  unitPrice     Float?
  createdAt     DateTime @default(now())
  product       Product? @relation(fields: [productId], references: [id])
  sale          Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([productId])
}

model Customer {
  id           String        @id @default(uuid())
  restaurantId String
  name         String
  phone        String?
  email        String?
  address      String?
  company      String?
  customerType CustomerType  @default(Individual)
  creditLimit  Float?
  notes        String?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id])
  debts        Debt[]
  debtPayments DebtPayment[]

  @@index([restaurantId])
  @@index([restaurantId, isActive])
  @@index([restaurantId, name])
}

model Debt {
  id              String        @id @default(uuid())
  restaurantId    String
  saleId          String?
  customerId      String
  principalAmount Float
  paidAmount      Float         @default(0)
  remainingAmount Float
  dueDate         DateTime?
  status          DebtStatus    @default(Outstanding)
  description     String?
  notes           String?
  createdBy       String
  createdByName   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  customer        Customer      @relation(fields: [customerId], references: [id])
  restaurant      Restaurant    @relation(fields: [restaurantId], references: [id])
  sale            Sale?         @relation(fields: [saleId], references: [id])
  payments        DebtPayment[]

  @@index([restaurantId])
  @@index([saleId])
  @@index([customerId])
  @@index([status])
  @@index([dueDate])
  @@index([restaurantId, status])
  @@index([customerId, status])
}

model DebtPayment {
  id              String           @id @default(uuid())
  restaurantId    String
  debtId          String
  customerId      String
  amount          Float
  paymentMethod   String
  paymentDate     DateTime
  receiptNumber   String?
  notes           String?
  receivedBy      String
  receivedByName  String?
  createdAt       DateTime         @default(now())
  bankTransaction BankTransaction?
  customer        Customer         @relation(fields: [customerId], references: [id])
  debt            Debt             @relation(fields: [debtId], references: [id], onDelete: Cascade)
  restaurant      Restaurant       @relation(fields: [restaurantId], references: [id])

  @@index([restaurantId])
  @@index([debtId])
  @@index([customerId])
  @@index([paymentDate])
}

model Expense {
  id                  String           @id @default(uuid())
  restaurantId        String
  date                DateTime
  categoryId          String?
  categoryName        String
  amountGNF           Float
  amountEUR           Float            @default(0)
  paymentMethod       String?
  description         String?
  receiptUrl          String?
  comments            String?
  transactionRef      String?
  lastModifiedBy      String?
  lastModifiedByName  String?
  lastModifiedAt      DateTime?
  supplierId          String?
  isInventoryPurchase Boolean          @default(false)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  fullyPaidAt         DateTime?
  paymentStatus       PaymentStatus    @default(Unpaid)
  totalPaidAmount     Float            @default(0)
  billingRef          String?
  category            Category?        @relation(fields: [categoryId], references: [id])
  restaurant          Restaurant       @relation(fields: [restaurantId], references: [id])
  supplier            Supplier?        @relation(fields: [supplierId], references: [id])
  expenseItems        ExpenseItem[]
  expensePayments     ExpensePayment[]
  stockMovements      StockMovement[]

  @@index([restaurantId])
  @@index([date])
  @@index([categoryId])
  @@index([supplierId])
  @@index([paymentStatus])
  @@index([restaurantId, paymentStatus, date])
}

model ExpenseItem {
  id              String        @id @default(uuid())
  expenseId       String
  inventoryItemId String
  quantity        Float
  unitCostGNF     Float
  expense         Expense       @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])

  @@index([expenseId])
  @@index([inventoryItemId])
}

model PaymentMethod {
  id           String     @id @default(uuid())
  restaurantId String
  name         String
  nameFr       String?
  type         String
  icon         String     @default("Wallet")
  color        String     @default("#C45C26")
  isActive     Boolean    @default(true)
  sortOrder    Int        @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, name])
  @@index([restaurantId, isActive])
}

model Category {
  id             String             @id @default(uuid())
  name           String             @unique
  nameFr         String?
  color          String?
  expenseGroupId String?
  isActive       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  expenseGroup   ExpenseGroup?      @relation(fields: [expenseGroupId], references: [id])
  suppliers      CategorySupplier[]
  expenses       Expense[]
}

model ExpenseGroup {
  id         String     @id @default(uuid())
  key        String     @unique
  label      String
  labelFr    String?
  icon       String
  color      String
  sortOrder  Int        @default(0)
  isActive   Boolean    @default(true)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  categories Category[]
}

model Supplier {
  id             String             @id @default(uuid())
  name           String             @unique
  phone          String?
  email          String?
  address        String?
  paymentTerms   String?
  isActive       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  categories     CategorySupplier[]
  expenses       Expense[]
  inventoryItems InventoryItem[]
}

model CategorySupplier {
  id         String   @id @default(uuid())
  categoryId String
  supplierId String
  category   Category @relation(fields: [categoryId], references: [id])
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  @@unique([categoryId, supplierId])
}

model BankTransaction {
  id             String                @id @default(uuid())
  restaurantId   String
  date           DateTime
  amount         Float
  type           BankTransactionType
  method         BankPaymentMethod
  reason         TransactionReason
  description    String?
  status         BankTransactionStatus @default(Pending)
  confirmedAt    DateTime?
  bankRef        String?
  receiptUrl     String?
  saleId         String?
  debtPaymentId  String?               @unique
  createdBy      String?
  createdByName  String?
  comments       String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  debtPayment    DebtPayment?          @relation(fields: [debtPaymentId], references: [id])
  restaurant     Restaurant            @relation(fields: [restaurantId], references: [id])
  sale           Sale?                 @relation("BankTransactionSale", fields: [saleId], references: [id])
  expensePayment ExpensePayment?

  @@unique([saleId, method])
  @@index([restaurantId])
  @@index([date])
  @@index([type])
  @@index([status])
  @@index([reason])
  @@index([method])
  @@index([restaurantId, status, date])
}

model ExpensePayment {
  id                String            @id @default(uuid())
  expenseId         String
  amount            Float
  paymentMethod     BankPaymentMethod
  paidAt            DateTime          @default(now())
  bankTransactionId String?           @unique
  paidBy            String?
  paidByName        String?
  notes             String?
  receiptUrl        String?
  createdAt         DateTime          @default(now())
  transactionId     String?
  bankTransaction   BankTransaction?  @relation(fields: [bankTransactionId], references: [id])
  expense           Expense           @relation(fields: [expenseId], references: [id])

  @@index([expenseId])
  @@index([paidAt])
}

model DailySummary {
  id                      String     @id @default(uuid())
  restaurantId            String
  date                    DateTime
  dailyCashSales          Float      @default(0)
  dailyOrangeSales        Float      @default(0)
  dailyCardSales          Float      @default(0)
  dailyCashExpenses       Float      @default(0)
  dailyOrangeExpenses     Float      @default(0)
  dailyCardExpenses       Float      @default(0)
  cumulativeCashBalance   Float      @default(0)
  cumulativeOrangeBalance Float      @default(0)
  cumulativeCardBalance   Float      @default(0)
  lowStockItemsCount      Int        @default(0)
  criticalStockItemsCount Int        @default(0)
  totalInventoryValueGNF  Float      @default(0)
  createdAt               DateTime   @default(now())
  updatedAt               DateTime   @updatedAt
  restaurant              Restaurant @relation(fields: [restaurantId], references: [id])

  @@unique([restaurantId, date])
  @@index([restaurantId])
  @@index([date])
}

model NotificationPreference {
  id                    String   @id @default(uuid())
  userId                String   @unique
  lowStockAlerts        Boolean  @default(true)
  criticalStockAlerts   Boolean  @default(true)
  expenseAlerts         Boolean  @default(true)
  approvalAlerts        Boolean  @default(true)
  dailySummary          Boolean  @default(true)
  largeExpenseThreshold Float?   @default(500000)
  preferredLocale       String   @default("fr")
  quietHoursStart       String?
  quietHoursEnd         String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  expiryAlerts          Boolean  @default(true)
  expiryWarningDays     Int      @default(7)
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model NotificationLog {
  id             String     @id @default(uuid())
  restaurantId   String
  recipientPhone String
  messageType    String
  message        String
  status         String
  providerMsgId  String?
  errorMessage   String?
  sentAt         DateTime   @default(now())
  deliveredAt    DateTime?
  restaurant     Restaurant @relation(fields: [restaurantId], references: [id])

  @@index([restaurantId])
  @@index([sentAt])
  @@index([status])
}

enum UserRole {
  Editor
  Manager
  Owner
  RestaurantManager
  Baker
  PastryChef
  Cashier
}

enum RestaurantType {
  Bakery
  Cafe
  Restaurant
  FastFood
}

enum MovementType {
  Purchase
  Usage
  Waste
  Adjustment
  TransferOut
  TransferIn
}

enum ProductionStatus {
  Planning
  Complete
}

enum ProductCategory {
  Patisserie
  Boulangerie
}

enum SubmissionStatus {
  Pending
  Approved
  Rejected
  Deleted
}

enum CustomerType {
  Individual
  Corporate
  Wholesale
}

enum DebtStatus {
  Outstanding
  PartiallyPaid
  FullyPaid
  Overdue
  WrittenOff
}

enum BankTransactionType {
  Deposit
  Withdrawal
}

enum BankPaymentMethod {
  Cash
  OrangeMoney
  Card
}

enum TransactionReason {
  SalesDeposit
  DebtCollection
  ExpensePayment
  OwnerWithdrawal
  CapitalInjection
  Other
}

enum BankTransactionStatus {
  Pending
  Confirmed
}

enum PaymentStatus {
  Unpaid
  PartiallyPaid
  Paid
}
